## 目标
在火山引擎 ECS 上部署家庭多人协同 Todo，支持数据持久化与后续更新。

## 准备
- ECS 系统：Ubuntu 24.04 64 bit
- 安全组放通：80 或 5173，22
- GitHub 仓库：https://github.com/roc-nju/home-todo-list

## Step 1 安装 Docker
```bash
sudo apt update
sudo apt install -y ca-certificates curl gnupg git
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo systemctl enable --now docker
```

## Step 2 拉取代码
```bash
cd ~
git clone https://github.com/roc-nju/home-todo-list
cd home-todo-list
```

## Step 3 构建镜像
```bash
sudo docker build -t home-todo:latest .
```

## Step 4 数据持久化
```bash
sudo mkdir -p /opt/home-todo
sudo cp data.json /opt/home-todo/data.json
sudo cp data.json /opt/home-todo/data.sqlite
```

## Step 5 启动服务
```bash
sudo docker rm -f home-todo >/dev/null 2>&1 || true
sudo docker run -d --restart=always \
  --name home-todo \
  -p 80:5173 \
  -e PORT=5173 \
  -e BASE_PATH=/home-todo \
  -e STORE=sqlite \
  -e SQLITE_FILE=/app/data.sqlite \
  -v /opt/home-todo/data.sqlite:/app/data.sqlite \
  home-todo:latest
```

## Step 6 访问地址
```
http://你的ECS公网IP/home-todo
```

## 更新流程
```bash
cd ~/home-todo-list
git pull
sudo docker build -t home-todo:latest .
sudo docker rm -f home-todo
sudo docker run -d --restart=always \
  --name home-todo \
  -p 80:5173 \
  -e PORT=5173 \
  -e BASE_PATH=/home-todo \
  -e STORE=sqlite \
  -e SQLITE_FILE=/app/data.sqlite \
  -v /opt/home-todo/data.sqlite:/app/data.sqlite \
  home-todo:latest
```
也可以使用脚本一键更新：
```bash
curl -fsSL https://raw.githubusercontent.com/roc-nju/home-todo-list/main/ecs_update.sh | bash
```

## 排查
```bash
sudo docker ps
sudo docker logs -f home-todo
```

## 备注
- 数据持久化路径：/opt/home-todo/data.sqlite
- 需要用 5173 访问时，将启动命令改成 `-p 5173:5173`
- 若修改访问后缀，请同步调整 BASE_PATH 与前端静态路径
