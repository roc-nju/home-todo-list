## 目标
在火山引擎 ECS 上部署家庭多人协同 Todo，支持持久化数据与后续便捷更新。

## 准备
- 一台 ECS 实例（Ubuntu 24.04 64 bit）
- 已开放安全组端口
  - 对外访问端口：80 或 5173
  - 管理端口：22
- ECS 上安装 Docker

## ECS 安装 Docker
```bash
sudo apt update
sudo apt install -y ca-certificates curl gnupg
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo $VERSION_CODENAME) stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo systemctl enable --now docker
```

## 一键执行（推荐）
在 ECS 上执行以下命令，一次性完成安装、拉取代码、构建镜像、启动服务：
```bash
curl -fsSL https://raw.githubusercontent.com/roc-nju/home-todo-list/main/ecs_onekey.sh | bash
```
如果提示 404，请先确认脚本已推送到 GitHub，或使用以下手动方式：
```bash
cat > ecs_onekey.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

APP_DIR="$HOME/home-todo-list"
DATA_DIR="/opt/home-todo"
IMAGE_NAME="home-todo:latest"
CONTAINER_NAME="home-todo"
PORT="5173"
REPO_URL="https://github.com/roc-nju/home-todo-list"

sudo apt update
sudo apt install -y ca-certificates curl gnupg git
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo systemctl enable --now docker

if [ ! -d "$APP_DIR" ]; then
  git clone "$REPO_URL" "$APP_DIR"
else
  git -C "$APP_DIR" pull
fi

cd "$APP_DIR"
sudo docker build -t "$IMAGE_NAME" .
sudo mkdir -p "$DATA_DIR"
if [ ! -f "$DATA_DIR/data.json" ]; then
  sudo cp data.json "$DATA_DIR/data.json"
fi
sudo docker rm -f "$CONTAINER_NAME" >/dev/null 2>&1 || true
sudo docker run -d --restart=always \
  --name "$CONTAINER_NAME" \
  -p 80:$PORT \
  -e PORT=$PORT \
  -v "$DATA_DIR/data.json:/app/data.json" \
  "$IMAGE_NAME"

echo "部署完成"
EOF

chmod +x ecs_onekey.sh
./ecs_onekey.sh
```

## 部署步骤
1. 在 ECS 上拉取代码
```bash
sudo apt update
sudo apt install -y git
git clone https://github.com/roc-nju/home-todo-list
```
2. 构建镜像
```bash
cd Home_ToDo_List
sudo docker build -t home-todo:latest .
```
3. 准备持久化数据文件
```bash
sudo mkdir -p /opt/home-todo
sudo cp data.json /opt/home-todo/data.json
```
4. 启动容器
```bash
sudo docker run -d --restart=always \
  --name home-todo \
  -p 80:5173 \
  -e PORT=5173 \
  -v /opt/home-todo/data.json:/app/data.json \
  home-todo:latest
```
5. 浏览器访问
```
http://你的ECS公网IP
```

## 更新流程
```bash
cd Home_ToDo_List
git pull
sudo docker build -t home-todo:latest .
sudo docker rm -f home-todo
sudo docker run -d --restart=always \
  --name home-todo \
  -p 80:5173 \
  -e PORT=5173 \
  -v /opt/home-todo/data.json:/app/data.json \
  home-todo:latest
```

## 常见问题
### 访问不了服务
- 确认 ECS 安全组已放通 80 或 5173 端口
- 确认容器在运行
```bash
sudo docker ps
```

### 数据是否丢失
- 数据文件持久化在 ECS 的 /opt/home-todo/data.json
- 只要磁盘不删除，任务数据不会丢

## 可选优化
- 绑定域名与 HTTPS：用 Nginx 反向代理到 5173
- 备份 data.json：定时复制到对象存储
